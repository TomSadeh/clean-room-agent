[task]
id = "RT-004"
description = "Fix session DB archival race condition: when the orchestrator runs multiple pipeline passes, the second pass's _restore_session_from_archive fails because the first pass's session was archived but the archive blob is corrupted by concurrent raw DB writes"
task_type = "bug_fix"

[context_requirements]
must_contain_files = [
  "src/clean_room_agent/retrieval/pipeline.py",
  "src/clean_room_agent/db/connection.py",
]

should_contain_files = [
  "src/clean_room_agent/orchestrator/runner.py",
  "src/clean_room_agent/db/raw_queries.py",
  "src/clean_room_agent/db/session_helpers.py",
]

must_not_contain = [
  "src/clean_room_agent/indexer/*",
  "src/clean_room_agent/execute/documentation.py",
  "src/clean_room_agent/knowledge_base/*",
  "src/clean_room_agent/extractors/*",
]

must_contain_information = [
  "Full source of _archive_session_finally function",
  "Full source of _restore_session_from_archive function",
  "How orchestrator runner calls run_pipeline for multiple passes",
  "get_connection factory including session DB path resolution",
  "insert_session_archive function signature and behavior",
]

budget_range = [35, 75]

[routing_notes]
reasoning = "Cross-cutting through pipeline.py, db/connection.py, orchestrator/runner.py. Needs scope (dependency chain from orchestrator to pipeline to DB) + precision (specific session management functions)."
